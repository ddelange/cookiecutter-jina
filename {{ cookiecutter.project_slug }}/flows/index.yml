!Flow
with:
  logserver: true
pods:
  crafter:
    uses: pods/craft.yml
    parallel: $PARALLEL
    read_only: true
  encoder:
    uses: pods/encode.yml
    parallel: $PARALLEL
    timeout_ready: 600000
    read_only: true
  chunk_idx:
    uses: pods/chunk.yml
    shards: $SHARDS
    separated_workspace: true
  doc_idx:
    uses: pods/doc.yml
    needs: crafter
  join_all:
    uses: _merge
    needs: [doc_idx, chunk_idx]
    read_only: true
requests:
  on:
    IndexRequest:
      - !VectorIndexDriver
        with:
          executor: vecidx
          traverse_on: chunks
          depth_range: [1, 1]
      - !KVIndexDriver
        with:
          executor: chunkidx
          traverse_on: chunks
          depth_range: [1, 1]
    SearchRequest:
      - !VectorSearchDriver
        with:
          executor: vecidx
          top_k: 5
          traverse_on: chunks
          depth_range: [0, 0]
      - !KVSearchDriver
        with:
          executor: chunkidx
          key: id
          #traverse_on: chunk_matches
          traverse_on: matches
          depth_range: [0, 1]
